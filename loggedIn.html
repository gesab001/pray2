<!DOCTYPE html>
<!--
Copyright (c) 2016 Google Inc.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email/Password Authentication Example</title>

  <!-- Material Design Theming -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>
  <script type='text/javascript' src='config.js'></script>
  <link rel="stylesheet" href="main.css">

  <!-- Import and configure the Firebase SDK -->
  <!-- These scripts are made available when the app is served or deployed on Firebase Hosting -->
  <!-- If you do not serve/host your project using Firebase Hosting see https://firebase.google.com/docs/web/setup -->
  <!-- The core Firebase JS SDK is always required and must be listed first -->
<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-app.js"></script>

  <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-analytics.js"></script>

  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-storage.js"></script>


 
</head>
<body>

<div id="container" style="display:none">
	<div id="userProfile"></div>
<button id="sign_out" onclick="signOut()">signOut</button>
<p id="userinfo"></p>
<h1 id="address">Dear heavenly Father</h1>
<textarea id="newprayer"></textarea>
<h1 id="sign">in Jesus' name, Amen.</h1>
<button onclick="submit()">submit</button>
<button onclick="downloadFile()">download</button>
<button onclick="addToDatabase()">database</button>
<button onclick="getPrayers()">list prayers</button>

<a id="url" href="">url</a>
<div id="prayer_list">

</div>
</div>


</body>
 <script type="text/javascript">
	 var prayer_list_container = document.getElementById("prayer_list");
	 document.getElementById("userinfo").innerHTML = "test";

	  // Initialize Firebase
	  firebase.initializeApp(firebaseConfig);
	  // Create a root reference
	  var storageRef = firebase.storage().ref();
      var db = firebase.firestore();

	  var user = JSON.parse(localStorage.getItem("user"));
	  if(user==null){
		  alert("please log in");
				  window.location = "firebase.html";
	  }else{
		  document.getElementById("container").style.display = "block";
		  document.getElementById("userProfile").innerHTML = JSON.stringify(user);
	  }
	  function submit(){
		  var address = document.getElementById("address").innerHTML;
  		  var sign = document.getElementById("sign").innerHTML;
		  var prayer = document.getElementById("newprayer").value;
		  var message = address + ", " + prayer + ", " + sign;
		      if (user!=null){
					alert(user.email);
					addToDatabase(message);
			  }else{
				  alert("please log in");
				  window.location = "firebase.html";
			  }

	  }
	  
	  function uploadFile(item){


			// Create a reference to 'mountains.jpg'
			var jsondata = {"items": []};
			jsondata.items.push(item);
            var message = JSON.stringify(jsondata);
			var ref = storageRef.child('prayerboard.json');
			ref.putString(message).then(function(snapshot) {
			  alert('Uploaded a raw string! ' + message);
			});


	  }
	  

	  function addToDatabase(message){
	   db.collection("rooms").doc("prayer").collection("private").doc(user.email).collection("messages").add({
			  message: message,
			  date: Date.now()

			})
			.then(function(event) {
				console.log("Document written with ID: ", event);
						  alert("database");
						  var element = document.createElement("P");
						  element.innerHTML = message;
					      prayer_list_container.append(element);

			})
			.catch(function(error) {
				console.error("Error adding document: ", error);
										  alert("error");

			});
	  }
	  
	  function getPrayers(){
		  var prayer_list_container = document.getElementById("prayer_list");
		  db.collection("prayers").get().then((querySnapshot) => {
				querySnapshot.forEach((doc) => {
					console.log(`${doc.id} => ${doc.data().message}`);
					var element = document.createElement("P");
					element.innerHTML = `${doc.data().message}`;
					prayer_list_container.append(element);
					
				});
			});
	  }
	  function downloadFile(){
		  alert("download");
		  // Create a reference to the file we want to download
			var starsRef = storageRef.child('prayerboard.json');

			// Get the download URL
			starsRef.getDownloadURL().then(function(url) {
			  // Insert url into an <img> tag to "download"
			  alert(url);
			  document.getElementById("url").href = url;
			  // This can be downloaded directly:
			  var xhr = new XMLHttpRequest();
			  xhr.responseType = 'json';
			  xhr.onload = function(event) {
				var jsondata = xhr.response;
				 alert(jsondata);
			  };
			  xhr.open('GET', url);
			  xhr.send();

			}).catch(function(error) {

			  // A full list of error codes is available at
			  // https://firebase.google.com/docs/storage/web/handle-errors
			  switch (error.code) {
				case 'storage/object-not-found':
				  // File doesn't exist
				  break;

				case 'storage/unauthorized':
				  // User doesn't have permission to access the object
				  alert("no permission");
				  break;

				case 'storage/canceled':
				  // User canceled the upload
				  break;


				case 'storage/unknown':
				  // Unknown error occurred, inspect the server response
				  break;
			  }
			});

		  
	}
    /**
     * Handles the sign out button press.
     */
   function signOut(){
	  firebase.auth().signOut().then(function() {
		  // Sign-out successful.
		  localStorage.removeItem("user");
		  alert(localStorage.getItem("user"));
		  alert("signout successful");
          window.location = 'firebase.html';
          
          
		}).catch(function(error) {
		  alert(error);
		}); 
   }


  </script>
</html>	
