<!DOCTYPE html>
<!--
Copyright (c) 2016 Google Inc.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email/Password Authentication Example</title>

  <!-- Material Design Theming -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>
  <script type='text/javascript' src='config.js'></script>
  <link rel="stylesheet" href="main.css">

  <!-- Import and configure the Firebase SDK -->
  <!-- These scripts are made available when the app is served or deployed on Firebase Hosting -->
  <!-- If you do not serve/host your project using Firebase Hosting see https://firebase.google.com/docs/web/setup -->
  <!-- The core Firebase JS SDK is always required and must be listed first -->
<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-app.js"></script>

  <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-analytics.js"></script>

  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-storage.js"></script>

  <!--Cryptography-->
 <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>


<style>
  .prayerItem{
    backgroundColor = "blue";
  }
</style>
 
</head>
<body>

<div id="container" style="display:none">
	<div id="userProfile"></div>
<button id="sign_out" onclick="signOut()">signOut</button>
<p id="userinfo"></p>
<h1 id="address">Dear heavenly Father</h1>
<textarea id="newprayer"></textarea>
<h1 id="sign">in Jesus' name, Amen.</h1>
<select id="messageType">
<option value="private">private</option>
<option value="friends">friends</option>
<option value="public">public</option>
</select>
<button onclick="submit()">submit</button>
<button onclick="downloadFile()">download</button>
<button onclick="addToDatabase()">database</button>
<button onclick="getPrayers()">list prayers</button>
<button onclick="getPublicPrayers()">get public prayers</button>
<button onclick="getPrivatePrayers()">get private prayers</button>

<a id="url" href="">url</a>

<h1>Private</h1>
<button onclick="dicipher()">dicipher</button>
<button onclick="encrypt()">encrypt</button>

<div id="prayer_list">

</div>

<h1>Public</h1>
<div id="prayer_list_public">

</div>
</div>


</body>
 <script type="text/javascript">
	 var prayer_list_container = document.getElementById("prayer_list");
	 var prayer_list_container_public = document.getElementById("prayer_list_public");

	 document.getElementById("userinfo").innerHTML = "test";
     var prayer = document.getElementById("newprayer");
	 var prayerItems = [];
	  // Initialize Firebase
	  firebase.initializeApp(firebaseConfig);
	  // Create a root reference
	  var storageRef = firebase.storage().ref();
      var db = firebase.firestore();
	  var user = JSON.parse(localStorage.getItem("user"));
	  if(user==null){
		  ////alert("please log in");
				  window.location = "index.html";
	  }else{
		  document.getElementById("container").style.display = "block";
		  document.getElementById("userProfile").innerHTML = JSON.stringify(user);
          getPrayers();
	  }
	  var encrypted = true;
	  function dicipher(	){
		var password = prompt("please enter password");
		if (password==user.uid){
		    encrypted = false;
			var items = document.getElementsByClassName("content");		
			for (var x=0; x<items.length; x++){
			   var bytes = CryptoJS.AES.decrypt(items[x].innerHTML.toString(), password);
			   var message = bytes.toString(CryptoJS.enc.Utf8);
			   items[x].innerHTML = message;
			}
		}else{
		   alert("wrong password");
		}
	  }
	  
	  function encrypt(){
	        if (encrypted==false){
				var items = document.getElementsByClassName("content");		
				for (var x=0; x<items.length; x++){
				   var message = items[x].innerHTML.toString();
				   var ciphertext = CryptoJS.AES.encrypt(message, user.uid);
				   items[x].innerHTML = ciphertext;
				}
			}
	  }
	  function submit(){
	      var messageType = document.getElementById("messageType").value;
	      ////alert(messageType);
		  var address = document.getElementById("address").innerHTML;
  		  var sign = document.getElementById("sign").innerHTML;
		  var newprayer = prayer.value;
		  if (newprayer.length>0){
			  var message = address + ", " + newprayer + ", " + sign;
               
				  if (user!=null){
						//alert(user.email);
						if (messageType=="private"){
						   //alert(messageType);
						   addToDatabase(message);
						}if (messageType=="public"){
						   //alert(messageType);
						   addToDatabasePublic(message);
						}if (messageType=="friends"){
						   //alert(messageType);
						   addToDatabaseFriends(message);
						}
				  }else{
					  //alert("please log in");
					  window.location = "index.html";
				  }
		  }else{
			  //alert("please enter your request");
		  }

	  }
	  
	  function uploadFile(item){


			// Create a reference to 'mountains.jpg'
			var jsondata = {"items": []};
			jsondata.items.push(item);
            var message = JSON.stringify(jsondata);
			var ref = storageRef.child('prayerboard.json');
			ref.putString(message).then(function(snapshot) {
			  //alert('Uploaded a raw string! ' + message);
			});


	  }
	  

	  function addToDatabase(message){
	   //alert(user.uid);
       var dateNow = Date.now();
	   var docRef = db.collection("rooms").doc("prayer").collection("private").doc(user.uid).collection("messages");
	   docRef.add({
              author: user.email,
			  userId: user.uid,
			  message: message,
			  date: dateNow

			}) 
			.then(function(doc) {
				//alert("Document written with ID: " + doc.id);
						  showItem(docRef, message, "private", dateNow, user.uid, doc.id);
					      

			})
			.catch(function(error) {
				console.error("Error adding document: ", error);
										  //alert("error");

			});
	  }

   function addToDatabasePublic(message){
       var dateNow = Date.now();
	   var docRef = db.collection("rooms").doc("prayer").collection("public");
	   docRef.add({
			  author: user.email,
			  userId: user.uid,
			  message: message,
			  date: dateNow

			})
			.then(function(doc) {
				console.log("Document written with ID: " + doc.id);
						  //alert("database");
				          showItem(docRef, message, "public", dateNow, user.uid, doc.id);

					      

			})
			.catch(function(error) {
				console.error("Error adding document: ", error);
										  //alert("error");

			});
	  }
	
	  function addToDatabaseFriends(message){
	  
	   db.collection("rooms").doc("prayer").collection("friends").doc(user.email).collection("messages").add({
              author: user.email,
			  message: message,
			  date: Date.now()

			})
			.then(function(event) {
				console.log("Document written with ID: ", event);
						  //alert("database");
						  var element = document.createElement("P");
						  element.innerHTML = message;
					      prayer_list_container.append(element);
					      prayer.value = "";
					      

			})
			.catch(function(error) {
				console.error("Error adding document: ", error);
										  //alert("error");

			});
	  }
	  	  
	  function getPrayers(){
          getPrivatePrayers();
		  getPublicPrayers();
      }	  
	  
	  function getPublicPrayers(){
	    var docRef = db.collection("rooms").doc("prayer").collection("public");
        var docRef1 = db.collection("rooms").doc("prayer").collection("public").orderBy("date", 'asc');
		docRef1.get()
		.then(querySnapshot => {
			querySnapshot.forEach(doc => {
				console.log(doc.id, " => ", doc.data());
				var message = doc.data().message;
				var id = doc.id;
				var userId = doc.data().userId;
				var date = doc.data().date;
				showItem(docRef, message, "public", date, userId, id);
				
			});
		});

	  
	  }

	  function getPrivatePrayers(){
	    var docRef = db.collection("rooms").doc("prayer").collection("private").doc(user.uid).collection("messages");
        var docRef1 = db.collection("rooms").doc("prayer").collection("private").doc(user.uid).collection("messages").orderBy("date", 'asc');
		docRef1.get()
		.then(querySnapshot => {
			querySnapshot.forEach(doc => {
				console.log(doc.id, " => ", doc.data());
				var message = doc.data().message;
				var id = doc.id;
				var userId = doc.data().userId;
				var date = doc.data().date;
				showItem(docRef, message, "private", date, userId, id);
				
			});
		});

	  
	  }
   
   function showItem(docRef, message, messageType, date, userId, id){

		var elementDiv = document.createElement("DIV");
		elementDiv.className = "prayerItem";
		elementDiv.setAttribute("id", id);
		elementP = document.createElement("P");
		elementP.className = "content";
		if (encrypted){
          var ciphertext = CryptoJS.AES.encrypt(message, user.uid);
    		elementP.innerHTML = ciphertext;

		}else{
				elementP.innerHTML = message;

		}
		elementDiv.append(elementP);
		elementDiv.onclick = function () {
		var deleteItem = confirm("delete?");
		
		if(deleteItem){
		      alert("userId: " + userId + " docId: " + id);
              if (userId==user.uid){
				 //alert("deleted: " + id);
				 docRef.doc(id).delete().then(function() {
					console.log("Document successfully deleted!");
				}).catch(function(error) {
					console.error("Error removing document: ", error);
				});
				document.getElementById(id).remove();
				};
			  }else{
			     //alert("you are not the author");
			  }
			
		}
		if (messageType=="private"){
		   prayer_list_container.insertBefore(elementDiv, prayer_list_container.firstChild);
		}		
		if (messageType=="public"){
		   prayer_list_container_public.insertBefore(elementDiv, prayer_list_container_public.firstChild);
		}
		document.getElementById("newprayer").value = "";
   }

	  function downloadFile(){
		  //alert("download");
		  // Create a reference to the file we want to download
			var starsRef = storageRef.child('prayerboard.json');

			// Get the download URL
			starsRef.getDownloadURL().then(function(url) {
			  // Insert url into an <img> tag to "download"
			  //alert(url);
			  document.getElementById("url").href = url;
			  // This can be downloaded directly:
			  var xhr = new XMLHttpRequest();
			  xhr.responseType = 'json';
			  xhr.onload = function(event) {
				var jsondata = xhr.response;
				 //alert(jsondata);
			  };
			  xhr.open('GET', url);
			  xhr.send();

			}).catch(function(error) {

			  // A full list of error codes is available at
			  // https://firebase.google.com/docs/storage/web/handle-errors
			  switch (error.code) {
				case 'storage/object-not-found':
				  // File doesn't exist
				  break;

				case 'storage/unauthorized':
				  // User doesn't have permission to access the object
				  //alert("no permission");
				  break;

				case 'storage/canceled':
				  // User canceled the upload
				  break;


				case 'storage/unknown':
				  // Unknown error occurred, inspect the server response
				  break;
			  }
			});

		  
	}
    /**
     * Handles the sign out button press.
     */
   function signOut(){
	  firebase.auth().signOut().then(function() {
		  // Sign-out successful.
		  localStorage.removeItem("user");
		  //alert(localStorage.getItem("user"));
		  //alert("signout successful");
          window.location = 'index.html';
          
          
		}).catch(function(error) {
		  //alert(error);
		}); 
   }


  </script>
</html>	
